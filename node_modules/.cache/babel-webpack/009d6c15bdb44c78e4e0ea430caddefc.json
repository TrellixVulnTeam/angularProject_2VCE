{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/regenerator\");\n\nvar _createForOfIteratorHelper = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _toConsumableArray = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _asyncToGenerator = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _classCallCheck = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@babel/runtime/helpers/createClass\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WebpackResourceLoader = void 0;\n/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n// TODO: fix typings.\n// tslint:disable-next-line:no-global-tslint-disable\n// tslint:disable:no-any\n\nvar path = require(\"path\");\n\nvar vm = require(\"vm\");\n\nvar webpack_sources_1 = require(\"webpack-sources\");\n\nvar utils_1 = require(\"./utils\");\n\nvar NodeTemplatePlugin = require('webpack/lib/node/NodeTemplatePlugin');\n\nvar NodeTargetPlugin = require('webpack/lib/node/NodeTargetPlugin');\n\nvar LibraryTemplatePlugin = require('webpack/lib/LibraryTemplatePlugin');\n\nvar SingleEntryPlugin = require('webpack/lib/SingleEntryPlugin');\n\nvar WebpackResourceLoader = /*#__PURE__*/function () {\n  function WebpackResourceLoader() {\n    _classCallCheck(this, WebpackResourceLoader);\n\n    this._context = '';\n    this._fileDependencies = new Map();\n    this._reverseDependencies = new Map();\n    this._cachedSources = new Map();\n    this._cachedEvaluatedSources = new Map();\n  }\n\n  _createClass(WebpackResourceLoader, [{\n    key: \"update\",\n    value: function update(parentCompilation) {\n      this._parentCompilation = parentCompilation;\n      this._context = parentCompilation.context;\n    }\n  }, {\n    key: \"getResourceDependencies\",\n    value: function getResourceDependencies(filePath) {\n      return this._fileDependencies.get(filePath) || [];\n    }\n  }, {\n    key: \"getAffectedResources\",\n    value: function getAffectedResources(file) {\n      return this._reverseDependencies.get(file) || [];\n    }\n  }, {\n    key: \"_compile\",\n    value: function () {\n      var _compile2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(filePath) {\n        var _this = this;\n\n        var outputOptions, relativePath, childCompiler, childCompilation, warnings, errors, _this$_parentCompilat, _this$_parentCompilat2, _iterator, _step, file, resolvedFile, entry, compilationHash, maybeSource, source;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (this._parentCompilation) {\n                  _context.next = 2;\n                  break;\n                }\n\n                throw new Error('WebpackResourceLoader cannot be used without parentCompilation');\n\n              case 2:\n                if (!filePath.match(/\\.[jt]s$/)) {\n                  _context.next = 4;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", Promise.reject(\"Cannot use a JavaScript or TypeScript file (\".concat(filePath, \") in a component's styleUrls or templateUrl.\")));\n\n              case 4:\n                outputOptions = {\n                  filename: filePath\n                };\n                relativePath = path.relative(this._context || '', filePath);\n                childCompiler = this._parentCompilation.createChildCompiler(relativePath, outputOptions);\n                childCompiler.context = this._context;\n                new NodeTemplatePlugin(outputOptions).apply(childCompiler);\n                new NodeTargetPlugin().apply(childCompiler);\n                new SingleEntryPlugin(this._context, filePath).apply(childCompiler);\n                new LibraryTemplatePlugin('resource', 'var').apply(childCompiler);\n                childCompiler.hooks.thisCompilation.tap('ngtools-webpack', function (compilation) {\n                  compilation.hooks.additionalAssets.tapAsync('ngtools-webpack', function (callback) {\n                    if (_this._cachedEvaluatedSources.has(compilation.fullHash)) {\n                      var cachedEvaluatedSource = _this._cachedEvaluatedSources.get(compilation.fullHash);\n\n                      compilation.assets[filePath] = cachedEvaluatedSource;\n                      callback();\n                      return;\n                    }\n\n                    var asset = compilation.assets[filePath];\n\n                    if (asset) {\n                      _this._evaluate({\n                        outputName: filePath,\n                        source: asset.source()\n                      }).then(function (output) {\n                        var evaluatedSource = new webpack_sources_1.RawSource(output);\n\n                        _this._cachedEvaluatedSources.set(compilation.fullHash, evaluatedSource);\n\n                        compilation.assets[filePath] = evaluatedSource;\n                        callback();\n                      }).catch(function (err) {\n                        return callback(err);\n                      });\n                    } else {\n                      callback();\n                    }\n                  });\n                }); // Compile and return a promise\n\n                _context.next = 15;\n                return new Promise(function (resolve, reject) {\n                  childCompiler.compile(function (err, childCompilation) {\n                    if (err) {\n                      reject(err);\n                    } else {\n                      resolve(childCompilation);\n                    }\n                  });\n                });\n\n              case 15:\n                childCompilation = _context.sent;\n                // Propagate warnings to parent compilation.\n                warnings = childCompilation.warnings, errors = childCompilation.errors;\n\n                if (warnings && warnings.length) {\n                  (_this$_parentCompilat = this._parentCompilation.warnings).push.apply(_this$_parentCompilat, _toConsumableArray(warnings));\n                }\n\n                if (errors && errors.length) {\n                  (_this$_parentCompilat2 = this._parentCompilation.errors).push.apply(_this$_parentCompilat2, _toConsumableArray(errors));\n                }\n\n                Object.keys(childCompilation.assets).forEach(function (assetName) {\n                  // Add all new assets to the parent compilation, with the exception of\n                  // the file we're loading and its sourcemap.\n                  if (assetName !== filePath && assetName !== \"\".concat(filePath, \".map\") && _this._parentCompilation.assets[assetName] == undefined) {\n                    _this._parentCompilation.assets[assetName] = childCompilation.assets[assetName];\n                  }\n                }); // Save the dependencies for this resource.\n\n                this._fileDependencies.set(filePath, new Set(childCompilation.fileDependencies));\n\n                _iterator = _createForOfIteratorHelper(childCompilation.fileDependencies);\n\n                try {\n                  for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                    file = _step.value;\n                    resolvedFile = utils_1.forwardSlashPath(file);\n                    entry = this._reverseDependencies.get(resolvedFile);\n\n                    if (entry) {\n                      entry.add(filePath);\n                    } else {\n                      this._reverseDependencies.set(resolvedFile, new Set([filePath]));\n                    }\n                  }\n                } catch (err) {\n                  _iterator.e(err);\n                } finally {\n                  _iterator.f();\n                }\n\n                compilationHash = childCompilation.fullHash;\n                maybeSource = this._cachedSources.get(compilationHash);\n\n                if (!maybeSource) {\n                  _context.next = 29;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", {\n                  outputName: filePath,\n                  source: maybeSource\n                });\n\n              case 29:\n                source = childCompilation.assets[filePath].source();\n\n                this._cachedSources.set(compilationHash, source);\n\n                return _context.abrupt(\"return\", {\n                  outputName: filePath,\n                  source: source\n                });\n\n              case 32:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function _compile(_x) {\n        return _compile2.apply(this, arguments);\n      }\n\n      return _compile;\n    }()\n  }, {\n    key: \"_evaluate\",\n    value: function () {\n      var _evaluate2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref) {\n        var outputName, source, _a, context;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                outputName = _ref.outputName, source = _ref.source;\n                // Evaluate code\n                context = {};\n                vm.runInNewContext(source, context, {\n                  filename: outputName\n                });\n\n                if (!(typeof context.resource === 'string')) {\n                  _context2.next = 7;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", context.resource);\n\n              case 7:\n                if (!(typeof ((_a = context.resource) === null || _a === void 0 ? void 0 : _a.default) === 'string')) {\n                  _context2.next = 9;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", context.resource.default);\n\n              case 9:\n                throw new Error(\"The loader \\\"\".concat(outputName, \"\\\" didn't return a string.\"));\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      function _evaluate(_x2) {\n        return _evaluate2.apply(this, arguments);\n      }\n\n      return _evaluate;\n    }()\n  }, {\n    key: \"get\",\n    value: function get(filePath) {\n      return this._compile(filePath).then(function (result) {\n        return result.source;\n      });\n    }\n  }]);\n\n  return WebpackResourceLoader;\n}();\n\nexports.WebpackResourceLoader = WebpackResourceLoader;","map":{"version":3,"sources":["/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/@ngtools/webpack/src/resource_loader.js"],"names":["Object","defineProperty","exports","value","WebpackResourceLoader","path","require","vm","webpack_sources_1","utils_1","NodeTemplatePlugin","NodeTargetPlugin","LibraryTemplatePlugin","SingleEntryPlugin","_context","_fileDependencies","Map","_reverseDependencies","_cachedSources","_cachedEvaluatedSources","parentCompilation","_parentCompilation","context","filePath","get","file","Error","match","Promise","reject","outputOptions","filename","relativePath","relative","childCompiler","createChildCompiler","apply","hooks","thisCompilation","tap","compilation","additionalAssets","tapAsync","callback","has","fullHash","cachedEvaluatedSource","assets","asset","_evaluate","outputName","source","then","output","evaluatedSource","RawSource","set","catch","err","resolve","compile","childCompilation","warnings","errors","length","push","keys","forEach","assetName","undefined","Set","fileDependencies","resolvedFile","forwardSlashPath","entry","add","compilationHash","maybeSource","runInNewContext","resource","_a","default","_compile","result"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WebpackResourceLoader = void 0;\n/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n// TODO: fix typings.\n// tslint:disable-next-line:no-global-tslint-disable\n// tslint:disable:no-any\nconst path = require(\"path\");\nconst vm = require(\"vm\");\nconst webpack_sources_1 = require(\"webpack-sources\");\nconst utils_1 = require(\"./utils\");\nconst NodeTemplatePlugin = require('webpack/lib/node/NodeTemplatePlugin');\nconst NodeTargetPlugin = require('webpack/lib/node/NodeTargetPlugin');\nconst LibraryTemplatePlugin = require('webpack/lib/LibraryTemplatePlugin');\nconst SingleEntryPlugin = require('webpack/lib/SingleEntryPlugin');\nclass WebpackResourceLoader {\n    constructor() {\n        this._context = '';\n        this._fileDependencies = new Map();\n        this._reverseDependencies = new Map();\n        this._cachedSources = new Map();\n        this._cachedEvaluatedSources = new Map();\n    }\n    update(parentCompilation) {\n        this._parentCompilation = parentCompilation;\n        this._context = parentCompilation.context;\n    }\n    getResourceDependencies(filePath) {\n        return this._fileDependencies.get(filePath) || [];\n    }\n    getAffectedResources(file) {\n        return this._reverseDependencies.get(file) || [];\n    }\n    async _compile(filePath) {\n        if (!this._parentCompilation) {\n            throw new Error('WebpackResourceLoader cannot be used without parentCompilation');\n        }\n        // Simple sanity check.\n        if (filePath.match(/\\.[jt]s$/)) {\n            return Promise.reject(`Cannot use a JavaScript or TypeScript file (${filePath}) in a component's styleUrls or templateUrl.`);\n        }\n        const outputOptions = { filename: filePath };\n        const relativePath = path.relative(this._context || '', filePath);\n        const childCompiler = this._parentCompilation.createChildCompiler(relativePath, outputOptions);\n        childCompiler.context = this._context;\n        new NodeTemplatePlugin(outputOptions).apply(childCompiler);\n        new NodeTargetPlugin().apply(childCompiler);\n        new SingleEntryPlugin(this._context, filePath).apply(childCompiler);\n        new LibraryTemplatePlugin('resource', 'var').apply(childCompiler);\n        childCompiler.hooks.thisCompilation.tap('ngtools-webpack', (compilation) => {\n            compilation.hooks.additionalAssets.tapAsync('ngtools-webpack', (callback) => {\n                if (this._cachedEvaluatedSources.has(compilation.fullHash)) {\n                    const cachedEvaluatedSource = this._cachedEvaluatedSources.get(compilation.fullHash);\n                    compilation.assets[filePath] = cachedEvaluatedSource;\n                    callback();\n                    return;\n                }\n                const asset = compilation.assets[filePath];\n                if (asset) {\n                    this._evaluate({ outputName: filePath, source: asset.source() })\n                        .then(output => {\n                        const evaluatedSource = new webpack_sources_1.RawSource(output);\n                        this._cachedEvaluatedSources.set(compilation.fullHash, evaluatedSource);\n                        compilation.assets[filePath] = evaluatedSource;\n                        callback();\n                    })\n                        .catch(err => callback(err));\n                }\n                else {\n                    callback();\n                }\n            });\n        });\n        // Compile and return a promise\n        const childCompilation = await new Promise((resolve, reject) => {\n            childCompiler.compile((err, childCompilation) => {\n                if (err) {\n                    reject(err);\n                }\n                else {\n                    resolve(childCompilation);\n                }\n            });\n        });\n        // Propagate warnings to parent compilation.\n        const { warnings, errors } = childCompilation;\n        if (warnings && warnings.length) {\n            this._parentCompilation.warnings.push(...warnings);\n        }\n        if (errors && errors.length) {\n            this._parentCompilation.errors.push(...errors);\n        }\n        Object.keys(childCompilation.assets).forEach(assetName => {\n            // Add all new assets to the parent compilation, with the exception of\n            // the file we're loading and its sourcemap.\n            if (assetName !== filePath\n                && assetName !== `${filePath}.map`\n                && this._parentCompilation.assets[assetName] == undefined) {\n                this._parentCompilation.assets[assetName] = childCompilation.assets[assetName];\n            }\n        });\n        // Save the dependencies for this resource.\n        this._fileDependencies.set(filePath, new Set(childCompilation.fileDependencies));\n        for (const file of childCompilation.fileDependencies) {\n            const resolvedFile = utils_1.forwardSlashPath(file);\n            const entry = this._reverseDependencies.get(resolvedFile);\n            if (entry) {\n                entry.add(filePath);\n            }\n            else {\n                this._reverseDependencies.set(resolvedFile, new Set([filePath]));\n            }\n        }\n        const compilationHash = childCompilation.fullHash;\n        const maybeSource = this._cachedSources.get(compilationHash);\n        if (maybeSource) {\n            return { outputName: filePath, source: maybeSource };\n        }\n        else {\n            const source = childCompilation.assets[filePath].source();\n            this._cachedSources.set(compilationHash, source);\n            return { outputName: filePath, source };\n        }\n    }\n    async _evaluate({ outputName, source }) {\n        var _a;\n        // Evaluate code\n        const context = {};\n        vm.runInNewContext(source, context, { filename: outputName });\n        if (typeof context.resource === 'string') {\n            return context.resource;\n        }\n        else if (typeof ((_a = context.resource) === null || _a === void 0 ? void 0 : _a.default) === 'string') {\n            return context.resource.default;\n        }\n        throw new Error(`The loader \"${outputName}\" didn't return a string.`);\n    }\n    get(filePath) {\n        return this._compile(filePath)\n            .then((result) => result.source);\n    }\n}\nexports.WebpackResourceLoader = WebpackResourceLoader;\n"]},"metadata":{},"sourceType":"script"}