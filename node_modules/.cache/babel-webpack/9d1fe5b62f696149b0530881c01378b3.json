{"ast":null,"code":"'use strict';\n\nvar querystring = require('querystring');\n\nvar common = require('./common');\n\nvar log = require('../logger').create('middleware:source-files');\n\nfunction findByPath(files, path) {\n  return Array.from(files).find(function (file) {\n    return file.path === path;\n  });\n}\n\nfunction composeUrl(url, basePath, urlRoot) {\n  return url.replace(urlRoot, '/').replace(/\\?.*$/, '').replace(/^\\/absolute/, '').replace(/^\\/base/, basePath);\n} // Source Files middleware is responsible for serving all the source files under the test.\n\n\nfunction createSourceFilesMiddleware(filesPromise, serveFile, basePath, urlRoot) {\n  return function (request, response, next) {\n    var requestedFilePath = composeUrl(request.url, basePath, urlRoot); // When a path contains HTML-encoded characters (e.g %2F used by Jenkins for branches with /)\n\n    var requestedFilePathUnescaped = composeUrl(querystring.unescape(request.url), basePath, urlRoot);\n    request.pause();\n    log.debug(\"Requesting \".concat(request.url));\n    log.debug(\"Fetching \".concat(requestedFilePath));\n    return filesPromise.then(function (files) {\n      // TODO(vojta): change served to be a map rather then an array\n      var file = findByPath(files.served, requestedFilePath) || findByPath(files.served, requestedFilePathUnescaped);\n      var rangeHeader = request.headers.range;\n\n      if (file) {\n        var acceptEncodingHeader = request.headers['accept-encoding'];\n        var matchedEncoding = Object.keys(file.encodings).find(function (encoding) {\n          return new RegExp(\"(^|.*, ?)\".concat(encoding, \"(,|$)\")).test(acceptEncodingHeader);\n        });\n        var content = file.encodings[matchedEncoding] || file.content;\n        serveFile(file.contentPath || file.path, rangeHeader, response, function () {\n          if (/\\?\\w+/.test(request.url)) {\n            common.setHeavyCacheHeaders(response); // files with timestamps - cache one year, rely on timestamps\n          } else {\n            common.setNoCacheHeaders(response); // without timestamps - no cache (debug)\n          }\n\n          if (matchedEncoding) {\n            response.setHeader('Content-Encoding', matchedEncoding);\n          }\n        }, content, file.doNotCache);\n      } else {\n        next();\n      }\n\n      request.resume();\n    });\n  };\n}\n\ncreateSourceFilesMiddleware.$inject = ['filesPromise', 'serveFile', 'config.basePath', 'config.urlRoot'];\nexports.create = createSourceFilesMiddleware;","map":{"version":3,"sources":["/Users/abdillahihussein/Documents/GitHub/angularProject/node_modules/karma/lib/middleware/source_files.js"],"names":["querystring","require","common","log","create","findByPath","files","path","Array","from","find","file","composeUrl","url","basePath","urlRoot","replace","createSourceFilesMiddleware","filesPromise","serveFile","request","response","next","requestedFilePath","requestedFilePathUnescaped","unescape","pause","debug","then","served","rangeHeader","headers","range","acceptEncodingHeader","matchedEncoding","Object","keys","encodings","encoding","RegExp","test","content","contentPath","setHeavyCacheHeaders","setNoCacheHeaders","setHeader","doNotCache","resume","$inject","exports"],"mappings":"AAAA;;AAEA,IAAMA,WAAW,GAAGC,OAAO,CAAC,aAAD,CAA3B;;AACA,IAAMC,MAAM,GAAGD,OAAO,CAAC,UAAD,CAAtB;;AAEA,IAAME,GAAG,GAAGF,OAAO,CAAC,WAAD,CAAP,CAAqBG,MAArB,CAA4B,yBAA5B,CAAZ;;AAEA,SAASC,UAAT,CAAqBC,KAArB,EAA4BC,IAA5B,EAAkC;AAChC,SAAOC,KAAK,CAACC,IAAN,CAAWH,KAAX,EAAkBI,IAAlB,CAAuB,UAACC,IAAD;AAAA,WAAUA,IAAI,CAACJ,IAAL,KAAcA,IAAxB;AAAA,GAAvB,CAAP;AACD;;AAED,SAASK,UAAT,CAAqBC,GAArB,EAA0BC,QAA1B,EAAoCC,OAApC,EAA6C;AAC3C,SAAOF,GAAG,CACPG,OADI,CACID,OADJ,EACa,GADb,EAEJC,OAFI,CAEI,OAFJ,EAEa,EAFb,EAGJA,OAHI,CAGI,aAHJ,EAGmB,EAHnB,EAIJA,OAJI,CAII,SAJJ,EAIeF,QAJf,CAAP;AAKD,C,CAED;;;AACA,SAASG,2BAAT,CAAsCC,YAAtC,EAAoDC,SAApD,EAA+DL,QAA/D,EAAyEC,OAAzE,EAAkF;AAChF,SAAO,UAAUK,OAAV,EAAmBC,QAAnB,EAA6BC,IAA7B,EAAmC;AACxC,QAAMC,iBAAiB,GAAGX,UAAU,CAACQ,OAAO,CAACP,GAAT,EAAcC,QAAd,EAAwBC,OAAxB,CAApC,CADwC,CAExC;;AACA,QAAMS,0BAA0B,GAAGZ,UAAU,CAACZ,WAAW,CAACyB,QAAZ,CAAqBL,OAAO,CAACP,GAA7B,CAAD,EAAoCC,QAApC,EAA8CC,OAA9C,CAA7C;AAEAK,IAAAA,OAAO,CAACM,KAAR;AAEAvB,IAAAA,GAAG,CAACwB,KAAJ,sBAAwBP,OAAO,CAACP,GAAhC;AACAV,IAAAA,GAAG,CAACwB,KAAJ,oBAAsBJ,iBAAtB;AAEA,WAAOL,YAAY,CAACU,IAAb,CAAkB,UAAUtB,KAAV,EAAiB;AACxC;AACA,UAAMK,IAAI,GAAGN,UAAU,CAACC,KAAK,CAACuB,MAAP,EAAeN,iBAAf,CAAV,IAA+ClB,UAAU,CAACC,KAAK,CAACuB,MAAP,EAAeL,0BAAf,CAAtE;AACA,UAAMM,WAAW,GAAGV,OAAO,CAACW,OAAR,CAAgBC,KAApC;;AAEA,UAAIrB,IAAJ,EAAU;AACR,YAAMsB,oBAAoB,GAAGb,OAAO,CAACW,OAAR,CAAgB,iBAAhB,CAA7B;AACA,YAAMG,eAAe,GAAGC,MAAM,CAACC,IAAP,CAAYzB,IAAI,CAAC0B,SAAjB,EAA4B3B,IAA5B,CACtB,UAAC4B,QAAD;AAAA,iBAAc,IAAIC,MAAJ,oBAAuBD,QAAvB,YAAwCE,IAAxC,CAA6CP,oBAA7C,CAAd;AAAA,SADsB,CAAxB;AAGA,YAAMQ,OAAO,GAAG9B,IAAI,CAAC0B,SAAL,CAAeH,eAAf,KAAmCvB,IAAI,CAAC8B,OAAxD;AAEAtB,QAAAA,SAAS,CAACR,IAAI,CAAC+B,WAAL,IAAoB/B,IAAI,CAACJ,IAA1B,EAAgCuB,WAAhC,EAA6CT,QAA7C,EAAuD,YAAY;AAC1E,cAAI,QAAQmB,IAAR,CAAapB,OAAO,CAACP,GAArB,CAAJ,EAA+B;AAC7BX,YAAAA,MAAM,CAACyC,oBAAP,CAA4BtB,QAA5B,EAD6B,CACS;AACvC,WAFD,MAEO;AACLnB,YAAAA,MAAM,CAAC0C,iBAAP,CAAyBvB,QAAzB,EADK,CAC8B;AACpC;;AACD,cAAIa,eAAJ,EAAqB;AACnBb,YAAAA,QAAQ,CAACwB,SAAT,CAAmB,kBAAnB,EAAuCX,eAAvC;AACD;AACF,SATQ,EASNO,OATM,EASG9B,IAAI,CAACmC,UATR,CAAT;AAUD,OAjBD,MAiBO;AACLxB,QAAAA,IAAI;AACL;;AAEDF,MAAAA,OAAO,CAAC2B,MAAR;AACD,KA3BM,CAAP;AA4BD,GAtCD;AAuCD;;AAED9B,2BAA2B,CAAC+B,OAA5B,GAAsC,CACpC,cADoC,EACpB,WADoB,EACP,iBADO,EACY,gBADZ,CAAtC;AAIAC,OAAO,CAAC7C,MAAR,GAAiBa,2BAAjB","sourcesContent":["'use strict'\n\nconst querystring = require('querystring')\nconst common = require('./common')\n\nconst log = require('../logger').create('middleware:source-files')\n\nfunction findByPath (files, path) {\n  return Array.from(files).find((file) => file.path === path)\n}\n\nfunction composeUrl (url, basePath, urlRoot) {\n  return url\n    .replace(urlRoot, '/')\n    .replace(/\\?.*$/, '')\n    .replace(/^\\/absolute/, '')\n    .replace(/^\\/base/, basePath)\n}\n\n// Source Files middleware is responsible for serving all the source files under the test.\nfunction createSourceFilesMiddleware (filesPromise, serveFile, basePath, urlRoot) {\n  return function (request, response, next) {\n    const requestedFilePath = composeUrl(request.url, basePath, urlRoot)\n    // When a path contains HTML-encoded characters (e.g %2F used by Jenkins for branches with /)\n    const requestedFilePathUnescaped = composeUrl(querystring.unescape(request.url), basePath, urlRoot)\n\n    request.pause()\n\n    log.debug(`Requesting ${request.url}`)\n    log.debug(`Fetching ${requestedFilePath}`)\n\n    return filesPromise.then(function (files) {\n      // TODO(vojta): change served to be a map rather then an array\n      const file = findByPath(files.served, requestedFilePath) || findByPath(files.served, requestedFilePathUnescaped)\n      const rangeHeader = request.headers.range\n\n      if (file) {\n        const acceptEncodingHeader = request.headers['accept-encoding']\n        const matchedEncoding = Object.keys(file.encodings).find(\n          (encoding) => new RegExp(`(^|.*, ?)${encoding}(,|$)`).test(acceptEncodingHeader)\n        )\n        const content = file.encodings[matchedEncoding] || file.content\n\n        serveFile(file.contentPath || file.path, rangeHeader, response, function () {\n          if (/\\?\\w+/.test(request.url)) {\n            common.setHeavyCacheHeaders(response) // files with timestamps - cache one year, rely on timestamps\n          } else {\n            common.setNoCacheHeaders(response) // without timestamps - no cache (debug)\n          }\n          if (matchedEncoding) {\n            response.setHeader('Content-Encoding', matchedEncoding)\n          }\n        }, content, file.doNotCache)\n      } else {\n        next()\n      }\n\n      request.resume()\n    })\n  }\n}\n\ncreateSourceFilesMiddleware.$inject = [\n  'filesPromise', 'serveFile', 'config.basePath', 'config.urlRoot'\n]\n\nexports.create = createSourceFilesMiddleware\n"]},"metadata":{},"sourceType":"script"}